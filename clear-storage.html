<!DOCTYPE html>
<html>
<head>
    <title>清理LocalStorage</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        button { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px 5px;
        }
        button:hover { background: #2563eb; }
        .warning { background: #fef3c7; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background: #e0f2fe; padding: 15px; border-radius: 5px; margin: 10px 0; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧹 投票系统 LocalStorage 清理工具</h1>
        
        <div class="warning">
            <strong>⚠️ 注意：</strong>此工具将清理浏览器中存储的投票相关数据。清理后您需要重新进行投票。
        </div>
        
        <h2>当前 LocalStorage 内容：</h2>
        <pre id="current-storage"></pre>
        
        <h2>操作选项：</h2>
        <button onclick="showCurrentStorage()">🔍 查看当前存储</button>
        <button onclick="clearVoteData()">🗑️ 清理投票数据</button>
        <button onclick="clearAllData()">🚨 清理所有数据</button>
        <button onclick="generateNewUserId()">🆔 重新生成用户ID</button>
        
        <div class="info" id="result"></div>
        
        <h2>使用说明：</h2>
        <ul>
            <li><strong>查看当前存储：</strong>显示所有保存的数据</li>
            <li><strong>清理投票数据：</strong>只清理投票相关的数据，保留其他设置</li>
            <li><strong>清理所有数据：</strong>清理整个 LocalStorage</li>
            <li><strong>重新生成用户ID：</strong>生成新的有效UUID格式用户ID</li>
        </ul>
    </div>

    <script>
        // UUID验证函数
        function isValidUUID(uuid) {
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            return uuidRegex.test(uuid);
        }
        
        // 生成UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // 显示当前存储
        function showCurrentStorage() {
            const storage = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                storage[key] = value;
            }
            
            document.getElementById('current-storage').textContent = 
                Object.keys(storage).length > 0 ? 
                JSON.stringify(storage, null, 2) : 
                '无存储数据';
            
            // 检查用户ID格式
            const userId = localStorage.getItem('user-id');
            let message = `发现 ${Object.keys(storage).length} 个存储项。`;
            
            if (userId) {
                if (isValidUUID(userId)) {
                    message += ` ✅ 用户ID格式正确: ${userId}`;
                } else {
                    message += ` ❌ 用户ID格式错误: ${userId}`;
                }
            } else {
                message += ' ℹ️ 未找到用户ID。';
            }
            
            showResult(message);
        }
        
        // 清理投票数据
        function clearVoteData() {
            const keysToRemove = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('poll-') || key === 'user-id' || key === 'current-user-id')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            showResult(`✅ 已清理 ${keysToRemove.length} 个投票相关数据项: ${keysToRemove.join(', ')}`);
            showCurrentStorage();
        }
        
        // 清理所有数据
        function clearAllData() {
            if (confirm('确定要清理所有LocalStorage数据吗？此操作不可撤销！')) {
                const count = localStorage.length;
                localStorage.clear();
                showResult(`✅ 已清理所有数据，共 ${count} 个项目。`);
                showCurrentStorage();
            }
        }
        
        // 重新生成用户ID
        function generateNewUserId() {
            const oldId = localStorage.getItem('user-id');
            const newId = generateUUID();
            localStorage.setItem('user-id', newId);
            
            let message = `✅ 已生成新的用户ID: ${newId}`;
            if (oldId) {
                message += `\n旧ID: ${oldId}`;
            }
            
            showResult(message);
            showCurrentStorage();
        }
        
        // 显示结果
        function showResult(message) {
            document.getElementById('result').innerHTML = '<strong>操作结果：</strong><br>' + message.replace(/\n/g, '<br>');
        }
        
        // 页面加载时显示当前存储
        window.onload = function() {
            showCurrentStorage();
        }
    </script>
</body>
</html>
